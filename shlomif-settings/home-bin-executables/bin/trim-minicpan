#!/usr/bin/env bash

# Script to trim a minicpan directory by not keeping old releases.
#
# Copyright by Shlomi Fish, 2016.
#
# Licensed under the MIT/Expat licence.

# Configuration:
set -e -x

common_prefix="$HOME/Download/Arcs/Perl"
localdir="$common_prefix/minicpan"
newlocal="$common_prefix/__New-minicpan"
oldlocal="$common_prefix/__Old-minicpan"
port=2908
webserver=/usr/sbin/thttpd

test -e "$localdir"
test -x "$webserver"
test \! -e "$newlocal"
test \! -e "$oldlocal"

mkdir -p "$newlocal"
/usr/sbin/thttpd -p "$port" -d "$localdir"
minicpan -r "http://localhost:${port}/" -l "$newlocal"
mv "$localdir" "$oldlocal"
pkill thttpd
mv "$newlocal" "$localdir"
